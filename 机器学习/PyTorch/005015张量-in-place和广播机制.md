---
tags: python ai pytorch 
---

# in-place和广播机制

## in-place

“就地”操作，即不允许使用临时变量，也称为原位操作。例如

```python
x = x + y
```

```
add_ sub_ mul_
```

 ## 广播机制

**广播机制**：张量参数可以自动扩展为相同大小。

### 条件

- 每个张量至少有一个维度
- 满足右对齐（不足维度，右对齐补1，如果对应维度**相等**或者**有一个是1**，则满足广播机制）

### 例子

✅ 满足广播机制

```
a = torch.rand(2, 3)
b = torch.rand(3)

## 解析：
# 1 右对齐 补一
(2, 3)
(1, 3)
# 2 比较
3和3相等，2和1有一个是1，所以满足广播机制
```

❌ 不满足广播机制

```
a = torch.rand(2, 3)
b = torch.rand(2)

## 解析：
# 1 右对齐 补一
(2, 3)
(1, 2)
# 2 比较
2和3不相等，所以不满足广播机制
```

### 如何计算

```python
a = torch.rand(2, 3)
b = torch.rand(3)
c = a + b
print(a)
print(b)
print(c)

'''
tensor([[0.5142, 0.1109, 0.9656],
        [0.6039, 0.3441, 0.9232]])
tensor([0.5558, 0.7475, 0.5213])
tensor([[1.0700, 0.8584, 1.4869],
        [1.1597, 1.0917, 1.4445]])

'''

## 解析：
# 1 广播机制自动扩展b 为（1，3）
# 2 第1维度相加 [0.5142, 0.1109, 0.9656] + [0.5558, 0.7475, 0.5213] = [1.0700, 0.8584, 1.4869]
# 3 第2维度，拷贝一份1维，再相加 [0.5558, 0.7475, 0.5213] + [0.6039, 0.3441, 0.9232] = [1.1597, 1.0917, 1.4445]
```

